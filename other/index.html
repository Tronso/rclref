<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Other - rclref</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="https://unpkg.com/mermaid@8.0.0/dist/mermaid.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Other";
    var mkdocs_page_input_path = "other.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> rclref</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">How to setup a riak_core_lite application?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../put_get_delete/">How are put, get, delete implemented in rclref?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../test/">How to test distributed Erlang application using Common Test?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../benchmark/">How to benchmark riak_core_lite application?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../usage/">How to actually use rclref?</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Other</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#how-to-configure-rclref">How to configure rclref?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-are-vector-clocks-implemented">How are vector clocks implemented?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-delete-a-tombstone-from-backend">How to delete a tombstone from backend?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-use-riak_core-instead-of-riak_core_lite">How to use riak_core instead of riak_core_lite?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#more-information-on-riak_core">More information on riak_core</a>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">rclref</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Other</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="other">Other</h1>
<p>This page provides information on stuff that has not been explained in other pages.</p>
<h2 id="how-to-configure-rclref">How to configure rclref?</h2>
<p>Configuring rclref is done in mostly in <code>rclref.app.src</code>. Environemntal values are defined in this module.
In order to check bugs in the config as earily as possible, environmental values are read using the <code>rclref_config</code> module.</p>
<h2 id="how-are-vector-clocks-implemented">How are vector clocks implemented?</h2>
<p>Please read the <a href="https://en.wikipedia.org/wiki/Vector_clock">wiki</a> if you don't know what vector clocks do.</p>
<p>When a client on node1 requests to put a new key-value in the database, a vector clock <code>[{node1, 1}]</code> will be created and stored together with the value.
Then if another client on node2 requests to put a value on the same key, the vector clock will be updated to <code>[{node1, 1}, {node2, 1}]</code> and stored together with the new value.</p>
<p>These vector clock operations are implemeted in the <a href="https://github.com/wattlebirdaz/rclref/blob/master/apps/rclref/src/rclref_object.erl"><code>rclref_object.erl</code></a> module using the <a href="https://github.com/AntidoteDB/vectorclock">vector clock library</a>.</p>
<div class="highlight"><pre><span></span><code><span class="p">-</span><span class="ni">spec</span> <span class="n">new_vclock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">vclock</span><span class="p">().</span>
<span class="nf">new_vclock</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">vectorclock</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>

<span class="p">-</span><span class="ni">spec</span> <span class="n">increment_vclock</span><span class="p">(</span><span class="nb">node</span><span class="p">(),</span> <span class="n">vclock</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">vclock</span><span class="p">().</span>
<span class="nf">increment_vclock</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">VClock</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">vectorclock</span><span class="p">:</span><span class="nf">update_with</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span>
                            <span class="k">fun</span> <span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
                                    <span class="nv">X</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">end</span><span class="p">,</span>
                            <span class="mi">1</span><span class="p">,</span>
                            <span class="nv">VClock</span><span class="p">).</span>
</code></pre></div>

<p>It is not always the case, however, that there is an order between two vector clocks. For example, <code>[{node1, 2}, {node2, 1}]</code> and <code>[{node1, 1}, {node2, 2}]</code> have no orders between them.  When updates happen concurrently, there is no causality between the two. On such occastion, it is necessary to have a strategy to merge two objects or a heuristic to select one from them or a strategy for not dealing with the conflict i.e. simply return two different values so that the client can resolve the conflict. </p>
<p>In rclref, no heuristics were implemented for selecting the value on concurrent updates. For simplicity, when concurrent updates happen, it just chooses either of the values. This is implemented in the merge function in <a href="https://github.com/wattlebirdaz/rclref/blob/master/apps/rclref/src/rclref_object.erl"><code>rclref_object.erl</code></a> module.</p>
<div class="highlight"><pre><span></span><code><span class="p">-</span><span class="ni">spec</span> <span class="n">merge</span><span class="p">([</span><span class="n">riak_object</span><span class="p">()])</span> <span class="o">-&gt;</span> <span class="n">riak_object</span><span class="p">().</span>
<span class="nf">merge</span><span class="p">([</span><span class="nv">RObj</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="nv">RObj</span><span class="p">;</span>
<span class="nf">merge</span><span class="p">([</span><span class="nv">RObj0</span><span class="p">,</span> <span class="nv">RObj1</span> <span class="p">|</span> <span class="nv">RObjs</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="nv">VClock0</span> <span class="o">=</span> <span class="n">vclock</span><span class="p">(</span><span class="nv">RObj0</span><span class="p">),</span>
    <span class="nv">VClock1</span> <span class="o">=</span> <span class="n">vclock</span><span class="p">(</span><span class="nv">RObj1</span><span class="p">),</span>
    <span class="nv">NewRObj</span> <span class="o">=</span>
        <span class="k">case</span> <span class="nn">vectorclock</span><span class="p">:</span><span class="nf">le</span><span class="p">(</span><span class="nv">VClock0</span><span class="p">,</span> <span class="nv">VClock1</span><span class="p">)</span> <span class="k">of</span>
          <span class="n">true</span> <span class="o">-&gt;</span>
              <span class="nv">RObj1</span><span class="p">;</span>
          <span class="n">false</span> <span class="o">-&gt;</span>
              <span class="nv">RObj0</span>
        <span class="k">end</span><span class="p">,</span>
    <span class="n">merge</span><span class="p">([</span><span class="nv">NewRObj</span><span class="p">]</span> <span class="o">++</span> <span class="nv">RObjs</span><span class="p">).</span>
</code></pre></div>

<h2 id="how-to-delete-a-tombstone-from-backend">How to delete a tombstone from backend?</h2>
<p>Tombstone is a key-value which has an undefined value. 
Tombstone is created when a client request a delete on a Key because delete request is internally converetd into a put request with key=Key, value=undefined. Tombstones are not transparent to the user but you can see them using the coverage calls in LowLevelAPI such as <code>rclref:list_all_objects()</code>.</p>
<p>The LowLevelAPI also provides a method to delete the tombstone completely from the backend which is <code>rclref:reap(Key)</code>. This function should only be used when the connection between nodes is stable otherwise the deleted value might resurrect.</p>
<h2 id="how-to-use-riak_core-instead-of-riak_core_lite">How to use riak_core instead of riak_core_lite?</h2>
<ol>
<li>Remove riak_core_lite and riak_core_lite_utils from rebar.config</li>
<li>Add riak_core as dependency.</li>
<li>Make a _checkouts directory in rclref. Clone riak_core into that and checkout branch develop-3.0</li>
<li>Comment riak_core_coverage_fsm.erl and riak_core_coverage_plan.erl out</li>
<li>Add riak_core.schema to dir _build/dev1/rel/rclref/lib manually</li>
<li>Use at most Erlang 22</li>
</ol>
<h2 id="more-information-on-riak_core">More information on riak_core</h2>
<p>These are websites that explain how to create riak_core applicaiton.
Note that riak_core and riak_core_lite have some differences e.g. coverage calls.</p>
<ul>
<li><a href="https://github.com/basho/riak_core/wiki">Riak Core wiki</a></li>
<li><a href="https://github.com/lambdaclass/riak_core_tutorial">Riak Core Tutorial: lambda class</a></li>
<li><a href="https://marianoguerra.github.io/riak-core-tutorial/">Riak Core Tutorial: Mariano Guerra</a></li>
<li><a href="http://efcasado.github.io/">A Gentle Introduction to Riak Core: Enrique Fernandez</a></li>
<li><a href="https://github.com/rzezeski/try-try-try/tree/master/2011">TryTryTry</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../usage/" class="btn btn-neutral" title="How to actually use rclref?"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../usage/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
